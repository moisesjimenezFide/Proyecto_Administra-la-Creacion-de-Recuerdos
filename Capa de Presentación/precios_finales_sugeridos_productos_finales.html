<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
        content="Módulo POS de Gestion de Precios Finales Sugeridos de Productos Finales de Creando Recuerdos" />
    <title> Gestión de Precios Finales Sugeridos de Productos Finales - Creando Recuerdos </title>

    <!-- Ícono y Fuentes -->
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <link href="https://fonts.googleapis.com/css?family=Allura:400" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Sono:wght@800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial&display=swap" rel="stylesheet">

    <!-- Estilos Bootstrap y propios -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="css/styles.css" rel="stylesheet" />
    <link href="css/menu.css" rel="stylesheet" />
</head>

<body>

    <!-- Navbar dinámico-->
    <div id="navbar"></div>


    <div class="container mt-4">
        <h2 class="text-center" style="font-family: 'Sono', sans-serif;"> Gestión de Precios Finales Sugeridos de
            Productos Finales </h2>
    </div>

    <div class="container my-5">
        <h4 class="mb-4"> Registro Productos Finales </h4>
        <form id="form-precio-final" class="row g-3">
            <div class="col-md-6">
                <label class="form-label"> Nombre del producto </label>
                <input type="text" class="form-control" id="nombre" required />
            </div>
            <div class="col-md-6">
                <label class="form-label"> Costo total de receta (₡) </label>
                <input type="number" class="form-control" id="costoReceta" required min="0" step="0.01" />
            </div>
            <div class="col-md-6">
                <label class="form-label"> Margen de Utilidad (%) </label>
                <input type="number" class="form-control" id="utilidad" required min="0" step="0.01" />
            </div>
            <div class="col-md-6">
                <label class="form-label"> Costo de empaque (₡) </label>
                <input type="number" class="form-control" id="empaque" required min="0" step="0.01" />
            </div>
            <div class="col-md-6">
                <label class="form-label"> IVA (%) </label>
                <input type="number" class="form-control" id="iva" required min="0" step="0.01" />
            </div>
            <div class="col-md-6">
                <label class="form-label"> Servicios (%) </label>
                <input type="number" class="form-control" id="servicio" required min="0" step="0.01" />
            </div>
            <div class="col-md-6">
                <label class="form-label"> Envío (%) </label>
                <input type="number" class="form-control" id="envio" required min="0" step="0.01" />
            </div>

            <div class="col-md-4">
                <label class="form-label"> Acción </label>
                <button type="submit" class="btn text-black w-100" style="background-color: #E27AB0;">Agregar</button>
            </div>
        </form>
    </div>

    <div class="container mt-4">
        <h4> Búsqueda de Productos Finales</h4>
    </div>
    <!-- Formulario de búsqueda -->
    <div class="container mt-4">
        <div class="input-group">
            <input type="text" id="busqueda" class="form-control" placeholder="Buscar producto...">
            <button class="input-group-text" id="btn_busqueda">Buscar <i class="fas fa-search"></i></button>
        </div>
    </div>

    <div class="container mt-4">
        <h4> Listado de Productos Finales </h4>
        <div class="table-responsive">
            <table id="tabla_precios" class="table table-bordered table-striped table-sm table-responsive text-center">
                <thead>
                    <tr>
                        <th class="align-middle"> Nombre </th>
                        <th> Costo de receta </th>
                        <th> Margen de Utilidad (%) </th>
                        <th> Costo de Margen de Utilidad </th>
                        <th> Costo de Empaque (₡) </th>
                        <th> IVA (%) </th>
                        <th> Servicios (%) </th>
                        <th> Envío (%) </th>
                        <th> Precio canal propio </th>
                        <th class="align-middle"> Uber </th>
                        <th class="align-middle"> Rappi </th>
                        <th class="align-middle"> Didi </th>
                        <th class="align-middle"> PedidosYa! </th>
                        <th class="align-middle"> Acciones </th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <p id="mensaje_no_resultados" class="text-center mt-3 text-muted" style="display: none;">
        No se encontraron coincidencias.
    </p>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(function () {
            $('#navbar').load('navbar.html');
            $('#footer').load('footer.html');

            let productos = [];
            let indiceEditando = null;

            function calcularPrecioFinal(costo, utilidad, empaque, iva, servicio, envio, canal = '') {
                let base = costo + empaque;
                base += base * (utilidad / 100);
                base += base * (iva / 100);
                base += base * (servicio / 100);
                base += base * (envio / 100);

                // Incrementos adicionales por canal
                const comisiones = {
                    'Uber': 0.30,
                    'Rappi': 0.25,
                    'Didi': 0.20,
                    'PedidosYa': 0.25,
                };

                if (canal && comisiones[canal]) {
                    base += base * comisiones[canal];
                }

                return base.toFixed(2);
            }

            function renderTabla() {
                const filtro = $('#busqueda').val().toLowerCase();
                const tbody = $('#tabla_precios tbody');
                tbody.empty();

                let hayResultados = false;

                productos.forEach((p, index) => {
                    if (p.nombre.toLowerCase().includes(filtro)) {
                        hayResultados = true;
                        tbody.append(`
              <tr>
                <td>${p.nombre}</td>
                <td>₡${p.costo}</td>
                <td>${p.utilidad}%</td>
                <td>₡${p.costoMargen}</td>
                <td>₡${p.empaque}</td>
                <td>${p.iva}%</td>
                <td>${p.servicio}%</td>
                <td>${p.envio}%</td>
                <td>₡${p.propio}</td>
                <td>₡${p.uber}</td>
                <td>₡${p.rappi}</td>
                <td>₡${p.didi}</td>
                <td>₡${p.pedidosYa}</td>
                <td class="actions">
                    <div class="d-flex flex-nowrap gap-2">
                     <button class="btn btn-secondary btn-sm"onclick="editar(${index})">Editar</button>
                     <button class="btn btn-danger btn-sm"onclick="eliminar(${index})">Eliminar</button>
                    </div>
                </td>
              </tr>
            `);
                    }
                });

                if (!hayResultados) {
                    $('#mensaje_no_resultados').show();
                } else {
                    $('#mensaje_no_resultados').hide();
                }
            }

            $('#form-precio-final').on('submit', function (p) {
                p.preventDefault();

                const nombre = $('#nombre').val().trim();
                const costo = parseFloat($('#costoReceta').val());
                const utilidad = parseFloat($('#utilidad').val());
                const empaque = parseFloat($('#empaque').val());
                const iva = parseFloat($('#iva').val());
                const servicio = parseFloat($('#servicio').val());
                const envio = parseFloat($('#envio').val());

                if (!nombre || isNaN(costo) || isNaN(utilidad) || isNaN(empaque) || isNaN(iva) || isNaN(servicio) || isNaN(envio)) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Valores inválidos',
                        text: 'Por favor, complete todos los campos con valores válidos.'
                    });
                    return;
                }

                const costoMargen = utilidad > 0 ? (costo / (utilidad / 100)).toFixed(2) : '0.00';

                if (indiceEditando === null && productos.some(p => p.nombre.toLowerCase() === nombre.toLowerCase())) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Producto ya existe',
                        text: `El producto "${nombre}" ya está registrado.`
                    });
                    return;
                }

                const nuevo = {
                    nombre,
                    costo: costo.toFixed(2),
                    utilidad,
                    costoMargen,
                    empaque: empaque.toFixed(2),
                    iva,
                    servicio,
                    envio,
                    propio: calcularPrecioFinal(costo, utilidad, empaque, iva, servicio, envio),
                    uber: calcularPrecioFinal(costo, utilidad, empaque, iva, servicio, envio, 'Uber'),
                    rappi: calcularPrecioFinal(costo, utilidad, empaque, iva, servicio, envio, 'Rappi'),
                    didi: calcularPrecioFinal(costo, utilidad, empaque, iva, servicio, envio, 'Didi'),
                    pedidosYa: calcularPrecioFinal(costo, utilidad, empaque, iva, servicio, envio, 'PedidosYa')
                };

                if (indiceEditando !== null) {
                    productos[indiceEditando] = nuevo;
                    Swal.fire({
                        icon: 'success',
                        title: 'Producto actualizado',
                        text: `"${nuevo.nombre}" ha sido modificado.`
                    });
                    indiceEditando = null;
                    $('#form-precio-final button[type="submit"]').text("Agregar");
                } else {
                    productos.push(nuevo);
                    Swal.fire({
                        icon: 'success',
                        title: 'Producto agregado',
                        text: `"${nuevo.nombre}" fue agregado exitosamente.`
                    });
                }

                renderTabla();
                this.reset();
            });


            window.eliminar = function (index) {
                const p = productos[index];
                Swal.fire({
                    title: `¿Desea eliminar este producto "(${p.nombre})"?`,
                    text: "Esta acción no se puede deshacer.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        productos.splice(index, 1);
                        renderTabla();
                        Swal.fire({
                            icon: 'success',
                            title: 'Eliminado',
                            text: `"${p.nombre}" ha sido eliminado.`
                        });
                    }
                });
            }

            window.editar = function (index) {
                const p = productos[index];
                Swal.fire({
                    title: `¿Desea editar este producto "(${p.nombre})"?`,
                    text: "Se cargarán los datos de este producto para modificarlos.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, editar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#nombre').val(p.nombre);
                        $('#costoReceta').val(p.costo);
                        $('#utilidad').val(p.utilidad);
                        $('#empaque').val(p.empaque);
                        $('#iva').val(p.iva);
                        $('#servicio').val(p.servicio);
                        $('#envio').val(p.envio);

                        indiceEditando = index;

                        const btn = document.querySelector('form button[type="submit"]');
                        btn.textContent = "Actualizar";
                    }
                });
            }

            $('#busqueda').on('input', renderTabla);
        });

        Promise.all([
            fetch("templates/navbar.html"),
            fetch("templates/footer.html")
        ])
            .then(async ([navbar_res, footer_res]) => {
                const navbar_html = await navbar_res.text();
                const footer_html = await footer_res.text();
                document.getElementById("navbar").innerHTML = navbar_html;
                document.getElementById("footer").innerHTML = footer_html;
            });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Footer dinámico -->
    <div id="footer"></div>

</body>

</html>
