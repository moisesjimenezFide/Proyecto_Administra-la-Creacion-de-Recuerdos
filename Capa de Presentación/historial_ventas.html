<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="M√≥dulo POS de Gestion de ventas de Creando Recuerdos" />
    <meta name="author" content="" />
    <title> Historial de Ventas - Creando Recuerdos </title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <link href="https://fonts.googleapis.com/css?family=Allura:400" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Sono:wght@800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="css/styles.css" rel="stylesheet" />
    <link href="css/menu.css" rel="stylesheet" />
</head>

<body>

    <div id="navbar"></div>

    <div class="container mt-5">
        <h2 class="text-center"> Historial de Ventas </h2>

        <div class="mb-3">
            <label for="filtroFecha" class="form-label"> Filtrar por Fecha </label>
            <input type="date" id="filtroFecha" class="form-control" />
        </div>

        <div class="mb-3">
            <button class="btn btn-info" onclick="filtrarVentas()">Filtrar</button>
        </div>

        <table class="table table-bordered table-striped table-sm table-responsive text-center">
            <thead>
                <tr>
                    <th> Fecha </th>
                    <th> Productos Vendidos </th>
                    <th> Precio Unitario </th>
                    <th> Cantidad </th>
                    <th> Precio Total </th>
                    <th> Total Venta </th>
                    <th> Acciones </th>
                </tr>
            </thead>
            <tbody id="historialVentas">
                <!-- Ventas se insertar√°n din√°micamente -->
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let ventas = JSON.parse(localStorage.getItem("ventas")) || [];

        const renderizarVentas = (ventasAMostrar) => {
            const historial = document.getElementById("historialVentas");
            historial.innerHTML = "";

            if (ventasAMostrar.length === 0) {
                const fila = historial.insertRow();
                const celda = fila.insertCell();
                celda.colSpan = 7;
                celda.textContent = "No hay ventas registradas para mostrar.";
                return;
            }

            ventasAMostrar.forEach((venta, index) => {
                const nombres = venta.productos.map(p => p.nombre).join(", ");
                const precios = venta.productos.map(p => `‚Ç°${p.precio.toFixed(2)}`).join(", ");
                const cantidades = venta.productos.map(p => p.cantidad).join(", ");
                const totales = venta.productos.map(p => `‚Ç°${p.total.toFixed(2)}`).join(", ");

                const fila = historial.insertRow();
                fila.innerHTML = `
            <td>${venta.fecha}</td>
            <td>${nombres}</td>
            <td>${precios}</td>
            <td>${cantidades}</td>
            <td>${totales}</td>
            <td>‚Ç°${venta.totalVenta.toFixed(2)}</td>
            <td>
                <button class="btn btn-secondary btn-sm" onclick="editarVenta(${index})">Editar</button>
                <button class="btn btn-danger btn-sm" onclick="eliminarVenta(${index})">Eliminar</button>
            </td>
        `;
            });
        };

        const filtrarVentas = () => {
            const fechaFiltro = document.getElementById("filtroFecha").value;
            if (!fechaFiltro) {
                renderizarVentas(ventas);
                return;
            }

            const ventasFiltradas = ventas.filter(v => v.fecha === fechaFiltro);
            renderizarVentas(ventasFiltradas);
        };

        // Funci√≥n para editar una venta en el historial
        const editarVenta = async (index) => {
            const venta = ventas[index];

            // Generar el texto actual de productos
            const productosTexto = venta.productos.map(p => `${p.nombre} (${p.cantidad})`).join(", ");

            const { value: nuevosDatos } = await Swal.fire({
                title: 'Editar productos y cantidades',
                input: 'textarea',
                inputLabel: 'Formato: Producto A (2), Producto B (1)',
                inputValue: productosTexto,
                showCancelButton: true,
                confirmButtonText: 'Actualizar',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value.trim()) {
                        return 'El campo no puede estar vac√≠o.';
                    }
                    const items = value.split(",");
                    for (let item of items) {
                        const match = item.trim().match(/^(.+)\s*\((\d+)\)$/);
                        if (!match || parseInt(match[2]) <= 0) {
                            return 'Formato inv√°lido o cantidad no v√°lida en: ' + item.trim();
                        }
                    }
                }
            });

            if (!nuevosDatos) return;

            // Parsear nuevos datos
            const productosEditados = nuevosDatos.split(",").map(item => {
                const [nombre, cantidad] = item.trim().split("(");
                const cantidadValida = parseInt(cantidad.replace(")", "").trim());
                return { nombre: nombre.trim(), cantidad: cantidadValida };
            });

            // Actualizar productos
            const productosOriginales = ventas[index].productos;
            ventas[index].productos = productosEditados;


            // Recalcular total con base en los productos originales (por nombre)
            let nuevoTotal = 0;
            productosEditados.forEach(producto => {
                const productoOriginal = productosOriginales.find(p => p.nombre === producto.nombre);
                if (productoOriginal) {
                    nuevoTotal += productoOriginal.precio * producto.cantidad;
                } else {
                    // En caso de que el producto no est√© en el original, podr√≠as mostrar advertencia o asumir precio 0
                    console.warn(`No se encontr√≥ el precio original del producto: ${producto.nombre}`);
                }
            });

            ventas[index].productos = productosEditados;
            ventas[index].totalVenta = nuevoTotal;


            localStorage.setItem("ventas", JSON.stringify(ventas));
            ventas = JSON.parse(localStorage.getItem("ventas"));

            Swal.fire({
                icon: 'success',
                title: 'Venta actualizada',
                text: 'Los productos y cantidades fueron modificados correctamente.',
                timer: 1800,
                showConfirmButton: false
            });

            ventas = JSON.parse(localStorage.getItem("ventas"));
            const fechaFiltro = document.getElementById("filtroFecha").value;
            if (fechaFiltro) {
                filtrarVentas();
            } else {
                renderizarVentas(ventas);
            }
        };

        // Funci√≥n para eliminar una venta en el historial
        const eliminarVenta = (index) => {
            Swal.fire({
                title: '¬øEst√°s seguro?',
                text: "Esta acci√≥n no se puede deshacer.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'S√≠, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    ventas.splice(index, 1);
                    localStorage.setItem("ventas", JSON.stringify(ventas));
                    ventas = JSON.parse(localStorage.getItem("ventas")); // ‚Üê üîÑ Sincronizar variable global
                    filtrarVentas();

                    Swal.fire({
                        title: 'Eliminado',
                        text: 'La venta ha sido eliminada.',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        };

        // Mostrar ventas autom√°ticamente al cargar la p√°gina
        window.addEventListener("DOMContentLoaded", () => {
            ventas = JSON.parse(localStorage.getItem("ventas")) || [];
            renderizarVentas(ventas);
        });

    </script>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        Promise.all([
            fetch("templates/navbar.html"),
            fetch("templates/footer.html")
        ])
            .then(async ([navbarRes, footerRes]) => {
                const navbarHTML = await navbarRes.text();
                const footerHTML = await footerRes.text();
                document.getElementById("navbar").innerHTML = navbarHTML;
                document.getElementById("footer").innerHTML = footerHTML;
            });
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>

</html>
