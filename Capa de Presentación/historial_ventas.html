<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Módulo POS de Gestion de ventas de Creando Recuerdos" />
    <meta name="author" content="" />
    <title> Historial de Ventas - Creando Recuerdos </title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <link href="https://fonts.googleapis.com/css?family=Allura:400" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Sono:wght@800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Arial&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="css/styles.css" rel="stylesheet" />
    <link href="css/menu.css" rel="stylesheet" />
</head>

<body>

    <div id="navbar"></div>

    <div class="container mt-5">
        <h2 class="text-center"> Historial de Ventas </h2>

        <div class="mb-3">
            <label for="filtroFecha" class="form-label"> Filtrar por Fecha </label>
            <input type="date" id="filtroFecha" class="form-control" />
        </div>

        <div class="mb-3">
            <button class="btn btn-info" onclick="filtrarVentas()">Filtrar</button>
        </div>

        <table class="table table-bordered table-striped table-sm text-center">
            <thead>
                <tr>
                    <th> Fecha </th>
                    <th> Productos Vendidos </th>
                    <th> Precio Unitario </th>
                    <th> Cantidad </th>
                    <th> Precio Total </th>
                    <th> Total Venta </th>
                    <th> Acciones </th>
                </tr>
            </thead>
            <tbody id="historialVentas">
                <!-- Ventas se insertarán dinámicamente -->
            </tbody>
        </table>
    </div>

    <!-- Footer dinámico -->
    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let ventas = JSON.parse(localStorage.getItem("ventas")) || [];

        const filtrarVentas = () => {
            const fechaFiltro = document.getElementById("filtroFecha").value;
            const historial = document.getElementById("historialVentas");
            historial.innerHTML = "";

            const filtradas = ventas.filter(v => v.fecha === fechaFiltro);

            if (filtradas.length > 0) {
                filtradas.forEach((venta, index) => {
                    const nombres = venta.productos.map(p => p.nombre).join(", ");
                    const precios = venta.productos.map(p => `₡${p.precio.toFixed(2)}`).join(", ");
                    const cantidades = venta.productos.map(p => p.cantidad).join(", ");
                    const totales = venta.productos.map(p => `₡${p.total.toFixed(2)}`).join(", ");

                    const fila = historial.insertRow();
                    fila.innerHTML = `
                    <tr>
                        <td>${venta.fecha}</td>
                        <td>${nombres}</td>
                        <td>${precios}</td>
                        <td>${cantidades}</td>
                        <td>${totales}</td>
                        <td>₡${venta.totalVenta.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="eliminarVenta(${index})">Eliminar</button>
                        </td>
                    </tr>
                `;
                });
            } else {
                const fila = historial.insertRow();
                const celda = fila.insertCell();
                celda.colSpan = 7;
                celda.textContent = "No hay ventas registradas para esta fecha.";
            }
        };

        const eliminarVenta = (index) => {
            if (confirm("¿Eliminar esta venta?")) {
                ventas.splice(index, 1);
                localStorage.setItem("ventas", JSON.stringify(ventas));
                filtrarVentas();
            }
        };

        Promise.all([
            fetch("templates/navbar.html"),
            fetch("templates/footer.html")
        ])
            .then(async ([navbarRes, footerRes]) => {
                const navbarHTML = await navbarRes.text();
                const footerHTML = await footerRes.text();
                document.getElementById("navbar").innerHTML = navbarHTML;
                document.getElementById("footer").innerHTML = footerHTML;
            });
    </script>
</body>

</html>
